name: Release the Binaries

on:
  push:
    tags: ["**"]

jobs:
  build:
    name: Build Binaries
    uses: ./.github/workflows/build.yml
  release:
    name: Create GitHub Release
    needs: build
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
        with:
          path: ./artifacts
      - name: Rename files
        run: |
          # Copliot generated code, if you try to use it as a template, 
          # and something went wrong, blame Copilot. (also this comment is generated by Copilot)
          # List of targets to rename
          targets=(
            "x86_64-unknown-linux-gnu"
            "aarch64-unknown-linux-gnu"
            "i686-unknown-linux-gnu"
            "armv7-unknown-linux-gnueabihf"
            "x86_64-unknown-linux-musl"
            "aarch64-unknown-linux-musl"
            "i686-unknown-linux-musl"
            "armv7-unknown-linux-musleabihf"
            "x86_64-pc-windows-gnu"
            "i686-pc-windows-gnu"
            "x86_64-apple-darwin"
            "aarch64-apple-darwin"
          )

          mkdir ./out
          for target in "${targets[@]}"; do
            src_dir="./artifacts/nanoda-${target}"
            dst_dir="./out"
            if [[ "$target" == *"windows"* ]]; then
              src_file="${src_dir}/nanoda.exe"
              dest_file="./${dst_dir}/nanoda-${target}.exe"
            else
              src_file="${src_dir}/nanoda"
              dest_file="./${dst_dir}/nanoda-${target}"
            fi
            if [[ -f "$src_file" ]]; then
              echo "✅ Found: $src_file → $dest_file"
              mv "$src_file" "$dest_file"
            else
              echo "⚠️  Skip: $src_file not found"
            fi
          done
      - name: Create release
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2
        with:
          draft: true
          generate_release_notes: true
          files: ./out/*
